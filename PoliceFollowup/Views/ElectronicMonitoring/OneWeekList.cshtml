@model IEnumerable<SharedLayer.Models.ElectronicMonitoringDTO>
@{
    ViewBag.Title = "قائمة المراقبة الالكترونية المنتهية خلال أسبوع";
}
<head>
    <link href="~/Content/CSSFiles/HomeStyle.css" rel="stylesheet" />
    <link href="~/Content/CSSFiles/StatusStyle.css" rel="stylesheet" />
    <style>
        * {
            text-align: right;
            direction: rtl;
        }

        body {
            background: #f5f6fa;
        }
        /* Modern Header Style */
        .page-header {
            background: linear-gradient(135deg, #81715e 0%, #ab9e8f 100%);
            padding: 30px;
            margin: 20px 5px 30px 5px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(129, 113, 94, 0.2);
            position: relative;
            overflow: hidden;
        }

            .page-header::before {
                content: '';
                position: absolute;
                top: 0;
                right: -100px;
                width: 200px;
                height: 200px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 50%;
            }

            .page-header::after {
                content: '';
                position: absolute;
                bottom: -50px;
                left: -50px;
                width: 150px;
                height: 150px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 50%;
            }

            .page-header h3 {
                color: white !important;
                margin: 0;
                font-size: 28px;
                font-weight: 600;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                position: relative;
                z-index: 1;
            }

            .page-header img {
                filter: brightness(0) invert(1);
                position: relative;
                z-index: 1;
            }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .page-header .badge-alert {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            margin-right: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }
            .alert-banner i {
                color: #f39c12;
                font-size: 24px;
                margin-left: 10px;
            }

            .alert-banner h5 {
                color: #856404;
                font-weight: 700;
                margin: 0 0 5px 0;
            }

            .alert-banner p {
                color: #856404;
                margin: 0;
                font-size: 13px;
            }

        /* Table Styles */
        table.dataTable thead th {
            background-color: #81715e !important;
            color: #fff !important;
            border: none !important;
            padding: 12px 8px !important;
            font-weight: 600 !important;
            font-size: 13px !important;
            text-align: center !important;
        }

        table.dataTable tbody tr {
            background: #fff;
            transition: background 0.2s ease;
        }

            table.dataTable tbody tr:hover {
                background: #f8f9fa !important;
            }

        table.dataTable tbody td {
            padding: 10px 8px !important;
            font-size: 12px !important;
            vertical-align: middle !important;
        }

        .dt-buttons .btn {
            background: #81715e;
            color: white;
            border: none;
            margin-left: 5px;
            transition: all 0.3s ease;
        }

            .dt-buttons .btn:hover {
                background: #6b5f50;
            }

        .dataTables_filter input {
            border: 2px solid #e0dad1 !important;
            border-radius: 6px !important;
            padding: 6px 12px !important;
        }

            .dataTables_filter input:focus {
                border-color: #81715e !important;
                outline: none !important;
            }
        /* Days Remaining Badge */
        .days-remaining {
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .days-critical {
            background-color: #dc3545;
            color: #fff;
            animation: pulse 2s infinite;
        }

        .days-warning {
            background-color: #ffc107;
            color: #333;
        }

        .days-normal {
            background-color: #28a745;
            color: #fff;
        }

        @@keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        
        @@media print {
            @@page {
                size: A3 landscape;
                font-size: 8px;
            }

            .page-header, .dt-buttons, .alert-banner {
                display: none !important;
            }
        }
    </style>
</head>

<div class="container-fluid mt-3">
    <!-- Modern Header -->
    <div class="row">
        <div class="col-md-12">
            <div class="page-header">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center" style="gap: 15px;">
                        <i class="fa fa-exclamation-triangle" style="font-size: 40px; color: white;"></i>
                        <h3 class="mb-0">قائمة المراقبة الإلكترونية المنتهية خلال أسبوع</h3>
                    </div>
                    <span class="badge-alert">
                        <i class="fa fa-exclamation-triangle"></i> تنبيه
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Banner -->
    <div class="alert-banner">
        <div class="d-flex align-items-center">
            <i class="fa fa-bell"></i>
            <div>
                <h5>تنبيه: حالات المراقبة القريبة من الانتهاء</h5>
                <p>هذه القائمة تعرض جميع حالات المراقبة الإلكترونية التي ستنتهي خلال الأيام السبعة القادمة. يرجى مراجعتها واتخاذ الإجراءات اللازمة.</p>
            </div>
        </div>
    </div>

    <!-- Table Card -->
    <div class="p-3 bg-white shadow-sm" style="border-radius: 12px;">
        <table id="TableId" class="display border-0 nowrap" style="width:100%;font-size:smaller">
            <thead>
                <tr>
                    <th>رقم التقرير</th>
                    <th>رقم الملف</th>
                    <th>رقم القضية</th>
                    <th>نوع الحكم</th>
                    <th>تاريخ بدء المراقبة</th>
                    <th>تاريخ انتهاء المراقبة</th>
                    <th>الأيام المتبقية</th>
                    <th>منشئ التقرير</th>
                    <th>التفاصيل</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

@section scripts {
    <!-- DataTables CSS -->
    <link href="~/Content/DataTables/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="~/Content/DataTables/css/responsive.dataTables.min.css" rel="stylesheet" />
    <link href="~/css/font-awesome.min.css" rel="stylesheet" />

    <!-- jQuery -->
    <script src="~/Scripts/jquery-3.4.1.min.js"></script>

    <!-- DataTables JS -->
    <script src="~/Scripts/DataTables/jquery.dataTables.min.js"></script>
    <script src="~/Scripts/DataTables/dataTables.responsive.min.js"></script>

    <!-- Buttons JS for export functionality -->
    <script src="~/Scripts/DataTables/dataTables.buttons.min.js"></script>
    <script src="~/Scripts/DataTables/buttons.flash.min.js"></script>
    <script src="~/Scripts/jszip.min.js"></script>
    <script src="~/Scripts/pdfmake/pdfmake.min.js"></script>
    <script src="~/Scripts/pdfmake/vfs_fonts.js"></script>
    <script src="~/Scripts/DataTables/buttons.html5.min.js"></script>
    <script src="~/Scripts/DataTables/buttons.print.min.js"></script>
    <script src="~/Scripts/mainScripts/InfoSourceDT.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            // Helper function to format date
            function formatDateColumn(data, type, row) {
                if (type === 'display' || type === 'filter') {
                    if (!data || data === null) {
                        return "";
                    }

                    var match = data.match(/\/Date\((\d+)\)\//);
                    if (match) {
                        var date = new Date(parseInt(match[1], 10));
                        var year = date.getFullYear();
                        var month = String(date.getMonth() + 1).padStart(2, '0');
                        var day = String(date.getDate()).padStart(2, '0');
                        return year + '-' + month + '-' + day;
                    }

                    try {
                        var date = new Date(data);
                        if (!isNaN(date.getTime())) {
                            var year = date.getFullYear();
                            var month = String(date.getMonth() + 1).padStart(2, '0');
                            var day = String(date.getDate()).padStart(2, '0');
                            return year + '-' + month + '-' + day;
                        }
                    } catch(e) {
                        // Continue to return invalid date
                    }

                    return "تاريخ غير صالح";
                }
                return data;
            }

            // Calculate days remaining
            function calculateDaysRemaining(endDateData) {
                if (!endDateData) return null;

                var endDate;
                var match = endDateData.match(/\/Date\((\d+)\)\//);
                if (match) {
                    endDate = new Date(parseInt(match[1], 10));
                } else {
                    endDate = new Date(endDateData);
                }

                if (isNaN(endDate.getTime())) return null;

                var today = new Date();
                today.setHours(0, 0, 0, 0);
                endDate.setHours(0, 0, 0, 0);

                var diffTime = endDate - today;
                var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                return diffDays;
            }

            var oTable;
            $.ajax({
                url: "@Url.Action("GetListOfOneWeekJson", "ElectronicMonitoring")",
                type: "GET",
                dataType: "json",
                success: function(data) {
                    // Filter data for records expiring within 7 days
                    var filteredData = data.filter(function(record) {
                        var daysRemaining = calculateDaysRemaining(record.EndMonitoringDate);
                        return daysRemaining !== null && daysRemaining >= 0 && daysRemaining <= 7;
                    });

                    oTable = $('#TableId').DataTable({
                        data: filteredData,
                        responsive: true,
                        columns: [
                            {
                                data: "ReportID",
                                width: "7%",
                                className: "text-center"
                            },
                            {
                                data: "FileNo",
                                width: "9%",
                                className: "text-center"
                            },
                            {
                                data: "CaseNo",
                                width: "11%",
                                className: "text-center"
                            },
                            {
                                data: "JudgmentType",
                                width: "12%",
                                className: "text-center"
                            },
                            {
                                data: "StartMonitoringDate",
                                width: "10%",
                                className: "text-center",
                                render: formatDateColumn
                            },
                            {
                                data: "EndMonitoringDate",
                                width: "10%",
                                className: "text-center",
                                render: formatDateColumn
                            },
                            {
                                data: "EndMonitoringDate",
                                width: "10%",
                                className: "text-center",
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        var days = calculateDaysRemaining(data);
                                        if (days === null) {
                                            return '<span class="days-remaining days-normal">غير محدد</span>';
                                        } else if (days === 0) {
                                            return '<span class="days-remaining days-critical">اليوم</span>';
                                        } else if (days === 1) {
                                            return '<span class="days-remaining days-critical">غداً</span>';
                                        } else if (days <= 3) {
                                            return '<span class="days-remaining days-critical">' + days + ' أيام</span>';
                                        } else if (days <= 7) {
                                            return '<span class="days-remaining days-warning">' + days + ' أيام</span>';
                                        } else {
                                            return '<span class="days-remaining days-normal">' + days + ' يوم</span>';
                                        }
                                    } else if (type === 'sort') {
                                        return calculateDaysRemaining(data) || 999;
                                    }
                                    return data;
                                }
                            },
                            {
                                data: "CreatedBy",
                                width: "12%",
                                className: "text-center"
                            },
                            {
                                data: null,
                                width: "7%",
                                className: "text-center",
                                orderable: false,
                                render: function (data, type, row) {
                                    return '<a href="/ElectronicMonitoring/ElectronicMonitoringDetails/' + row.ReportID  +
                                           '" target="_blank" data-toggle="tooltip" data-placement="left" title="عرض التفاصيل" ' +
                                           'style="text-decoration:none"><img src="/Content/images/View.png" width="26" ' +
                                           'style="transition: transform 0.2s;" onmouseover="this.style.transform=\'scale(1.1)\'" ' +
                                           'onmouseout="this.style.transform=\'scale(1)\'" /> </a>';
                                }
                            }
                        ],
                        order: [[6, 'asc']], // Sort by days remaining (ascending)
                        language: {
                            search: "",
                            searchPlaceholder: "🔍 البحث...",
                            sLengthMenu: "عرض _MENU_ سجل",
                            info: "عرض _START_ إلى _END_ من إجمالي _TOTAL_ سجل",
                            infoFiltered: "(تصفية من _MAX_ سجل)",
                            infoEmpty: "لا توجد حالات قريبة من الانتهاء",
                            zeroRecords: "لم يتم العثور على نتائج",
                            paginate: {
                                next: 'التالي',
                                previous: 'السابق'
                            }
                        },
                        dom: 'Bfrtip',
                        buttons: [
                            {
                                extend: 'copy',
                                text: '<i class="fa fa-copy"></i> نسخ',
                                className: 'btn btn-sm buttons-copy'
                            },
                            {
                                extend: 'excel',
                                text: '<i class="fa fa-file-excel-o"></i> إكسل',
                                className: 'btn btn-sm buttons-excel',
                                exportOptions: {
                                    columns: [0, 1, 2, 3, 4, 5, 6, 7]
                                }
                            },
                            {
                                extend: 'print',
                                text: '<i class="fa fa-print"></i> طباعة',
                                className: 'btn btn-sm buttons-print',
                                exportOptions: {
                                    columns: [0, 1, 2, 3, 4, 5, 6, 7]
                                }
                            }
                        ],
                        initComplete: function () {
                            $('.dataTables_filter input').addClass('form-control');
                            $('[data-toggle="tooltip"]').tooltip();
                        }
                    });

                    $('input', oTable.table().header()).on('keyup', function () {
                        var colIdx = $(this).closest('th').index();
                        oTable.column(colIdx).search(this.value).draw();
                    });
                },
                error: function(xhr, status, error) {
                    console.error("حدث خطأ:", status, error);
                    alert("حدث خطأ أثناء تحميل البيانات. الرجاء المحاولة مرة أخرى.");
                }
            });
        });
    </script>
}