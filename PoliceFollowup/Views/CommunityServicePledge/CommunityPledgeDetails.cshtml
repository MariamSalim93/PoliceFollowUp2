@model SharedLayer.Models.CommunityServicePledgeDTO

@{
    ViewBag.Title = "تفاصيل تعهد الخدمة المجتمعية";
}

<head>
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-3.7.1.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <link href="~/Content/CSSFiles/HomeStyle.css" rel="stylesheet" />

    <style>
        * {
            text-align: right;
            direction: rtl
        }

        body {
            background: #f5f6fa;
            overflow-x: hidden;
        }

        .container-fluid {
            font-size: 12px;
        }

        h3 {
            font-size: 18px !important;
        }

        .page-header {
            background: linear-gradient(135deg, #81715e 0%, #ab9e8f 100%);
            padding: 30px;
            margin: 20px 5px 30px 5px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(129, 113, 94, 0.2);
            position: relative;
        }
        

        .header-actions {
            position: relative;
            z-index: 10;
        }
            .page-header::before {
                content: '';
                position: absolute;
                top: 0;
                right: -100px;
                width: 200px;
                height: 200px;
                background: rgba(255,255,255,0.1);
                border-radius: 50%;
            }

            .page-header::after {
                content: '';
                position: absolute;
                bottom: -50px;
                left: -50px;
                width: 150px;
                height: 150px;
                background: rgba(255,255,255,0.05);
                border-radius: 50%;
            }

            .page-header h3 {
                color: #fff !important;
                margin: 0;
                font-size: 28px !important;
                font-weight: 600;
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
                position: relative;
                z-index: 1;
            }


            .page-header img {
                position: relative;
                z-index: 1;
                width: 45px;
                background: #f4f1ed;
                padding: 8px;
                border-radius: 10px;
            }

        .Subtitle {
            background-color: #81715e0e;
            color: #81715e;
            padding: 10px;
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 10px;
            border-right: 4px solid #81715e;
        }

        .control-label {
            font-weight: 600;
            color: #6b5f50;
            font-size: 12px;
        }

        .form-control {
            font-size: 12px;
        }

        .detail-value {
            color: #333;
            font-size: 11px;
        }

        .row-detail {
            padding: 5px 0;
            border-bottom: 1px solid #f5f5f5;
        }

            .row-detail:last-child {
                border-bottom: none;
            }

        .status-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .status-active {
            background-color: #28a745;
            color: #fff;
        }

        .status-pending {
            background-color: #ffc107;
            color: #333;
        }

        .status-inactive {
            background-color: #29579d;
            color: #fff;
        }

        .status-cancel {
            background-color: #ef2828;
            color: #fff;
        }

        .status-inprocess {
            background-color: #e0782d;
            color: #fff;
        }

        .btn-back, .btn-edit {
            display: inline-flex;
            align-items: center;
            gap: .25rem;
            padding: 5px 15px;
            font-size: 11px;
            line-height: 1.2;
            border-radius: 8px;
            border: 0;
            vertical-align: middle;
            transition: all .3s ease;
        }

        .btn-edit {
            background: #ffc107;
            color: #4e4a45;
        }

            .btn-edit:hover {
                background: #e0a800;
                color: #fff;
            }

        .btn-back {
            background: #81715e;
            color: #fff;
        }

            .btn-back:hover {
                background: #6b5f50;
                color: #fff;
            }

        .header-actions {
            margin-right: auto;
        }

        .table {
            font-size: 11px;
        }

            .table th {
                font-size: 11px;
                padding: 5px;
            }

            .table td {
                padding: 5px;
            }

        .p-3 {
            padding: .75rem !important;
        }

        .p-2 {
            padding: .5rem !important;
        }

        .btn i {
            font-size: 10px;
        }

        .section-container {
            background-color: #fff;
            border: 1px solid #e3e3e3;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .left-column, .right-column {
            padding: 0 15px;
        }

        .service-period-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

            .service-period-box .period-label {
                color: #2e7d32;
                font-weight: 700;
                font-size: 11px;
                margin-bottom: 5px;
            }

            .service-period-box .period-value {
                color: #1b5e20;
                font-size: 14px;
                font-weight: 600;
            }

        .signature-box {
            background-color: #f9f9f9;
            border: 2px dashed #81715e;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 10px;
        }

        .text-right {
            text-align: right !important;
        }

        .text-center {
            text-align: center !important;
        }

        @@media print {
            .btn-back, .btn-edit, .header-actions {
                display: none !important;
            }

            .col-md-6 {
                width: 50% !important;
                float: right !important;
            }

            .declaration-box {
                background: #fff8e6;
                border: 1px dashed #d6b98a;
                border-radius: 8px;
                padding: 10px 12px;
                color: #5a5248;
                font-size: 12px;
                margin-bottom: 10px;
                line-height: 1.8;
            }
        }
    </style>
</head>

<div class="container-fluid mt-3">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div class="p-3 bg-white shadow-sm">
        <div class="row">
            <div class="col-md-12">
                <div class="page-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center" style="gap: 15px;">
                            <img src="~/Content/images/report.png" width="40" />
                            <h3 class="mb-0">تفاصيل تعهد الخدمة المجتمعية</h3>
                        </div>
                        <div class="header-actions d-flex" style="gap: 10px;">
                            @using (Html.BeginForm("UpdateReport", "CommunityServicePledge", new { id = Model.ReportID }, FormMethod.Get, new { @class = "m-0" }))
                            {
                                <button type="submit" class="btn btn-warning btn-sm d-inline-flex align-items-center gap-1">
                                    <i class="fa fa-edit"></i> تعديل
                                </button>
                            }
                            <a href='@Url.Action("CommunityPledgeList", "CommunityServicePledge")' class="btn btn-light btn-sm d-inline-flex align-items-center gap-1">
                                <i class="fas fa-arrow-right"></i> رجوع
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <br />

        <!-- Two Column Layout -->
        <div class="row">
            <!-- Left Column -->
            <div class="col-md-8 left-column">
                <!-- معلومات التقرير -->
                <div class="section-container">
                    <div class="Subtitle">
                        معلومات التقرير
                        @{
                            string statusClass = Model.Status == "جديد" ? "status-inactive" :
                                                 Model.Status == "تم التعديل" ? "status-pending" :
                                                 Model.Status == "قيد المراجعة" ? "status-inprocess" :
                                                 Model.Status == "ملغي" ? "status-cancel" : "status-active";
                        }
                        <span class="status-badge @statusClass" style="float:left">@Model.Status</span>
                    </div>
                    <div class="p-2">
                        <div class="row-detail">
                            <div class="row">
                                <div class="col-sm-3"><label class="control-label">رقم التقرير</label></div>
                                <div class="col-sm-3"><span class="detail-value">@Model.ReportID</span></div>
                                <div class="col-sm-3"><label class="control-label">رقم الملف</label></div>
                                <div class="col-sm-3 d-flex align-items-center">
                                    <span class="detail-value" style="margin-left:8px;">@Model.FileNo</span>
                                    <a href="@Url.Action("ConvictFileDetails", "ConvictFile", new { id = Model.FileNo })"
                                       target="_blank"
                                       data-toggle="tooltip"
                                       data-placement="left"
                                       title="عرض ملف المحكوم"
                                       class="btn btn-sm btn-Add"
                                       style="font-size:11px; margin-right:8px;">
                                        <i class="fas fa-folder-open ml-1"></i> عرض ملف المحكوم
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- بيانات الحكم والخدمة -->
                <div class="section-container">
                    <div class="Subtitle">بيانات الحكم والخدمة المجتمعية</div>
                    <div class="p-2">
                        <div class="row-detail">


                            @Model.FileNo  <!-- 14 -->
                            @ViewBag.Data.ReportID <!-- 14 -->
                            <!-- its return data of 8  -->
                            @if (Model.FileNo == ViewBag.Data.ReportID)
                            {
                                <div class="row">
                                    <div class="col-sm-3"><label class="control-label">اسم المحكوم</label></div>
                                    <div class="col-sm-3"><span class="detail-value">@ViewBag.Data.Name</span></div>
                                    <div class="col-sm-3"><label class="control-label">الرقم الموحد</label></div>
                                    <div class="col-sm-3"><span class="detail-value">@ViewBag.Data.UnifiedNo</span></div>
                                </div>
                            }

                        </div>
                        <div class="row-detail">
                            <div class="row">

                                <div class="col-sm-3"><label class="control-label">نوع التهمة بموجب الأمر أو الحكم الصادر</label></div>
                                <div class="col-sm-3"><span class="detail-value">@Model.AccusationType</span></div>
                            </div>
                        </div>

                        <div class="row-detail">
                            <div class="row">
                                <div class="col-sm-3"><label class="control-label">تاريخ بدء الخدمة</label></div>
                                <div class="col-sm-3"><span class="detail-value">@Html.DisplayFor(m => m.StartDate)</span></div>
                                <div class="col-sm-3"><label class="control-label">تاريخ انتهاء الخدمة</label></div>
                                <div class="col-sm-3"><span class="detail-value">@Html.DisplayFor(m => m.EndDate)</span></div>
                            </div>
                        </div>
                        <!-- تعهد وإقرار -->
                        <div class="p-2">
                            <div class="declaration-box">
                                <strong>تعهد وإقرار:</strong>
                                <span>
                                    أقر أنا .............................................. حامل البيانات الموضحة أعلاه
                                    بانه تم تدريبي وشرح قواعد الخدمة المجتمعية وعلى ان التزم بتطبيق الخدمة المجتمعية حسب ما ورد بنص الحكم وبالأوامر والتعليمات الصادرة من الجهة المنفذة للخدمة المجتمعية وأن أتحمل كافة المساءلات القانونية في حال مخالفتي لما ذكر أعلاه..

                                </span>
                            </div>
                        </div>
                        <!-- التوقيع -->
                        <!-- التوقيع -->
                        <!-- التوقيع -->
                        <!-- التوقيع -->
                        <div class="signature-box">
                            <label class="control-label" style="color:#81715e; font-size:larger;">التوقيع</label>

                            @if (!string.IsNullOrWhiteSpace(Model.Signature))
                            {
                                <!-- Display existing signature -->
                                <div class="mt-3 text-center">
                                    <img src="@Url.Content(Model.Signature)" alt="التوقيع"
                                         style="max-width: 100%; max-height: 150px; border: 1px solid #81715e; padding: 10px; border-radius: 8px; background: white;" />
                                    <div class="mt-2">
                                        <span class="detail-value" style="font-size:12px; color:#6b5f50; font-weight:600;">
                                            تم التوقيع بواسطة: @ViewBag.Data.Name
                                        </span>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <!-- Signature Form - Only shown if no signature exists -->
                                using (Html.BeginForm("SignFile", "CommunityServicePledge", FormMethod.Post, new { id = "signForm" }))
                                {
                                    @Html.AntiForgeryToken()
                                    @Html.HiddenFor(m => m.ReportID)

                                    @Html.HiddenFor(m => m.Signature)

                                    <div class="mt-3">
                                        <label style="font-size:small; color:#6b5f50; font-weight:600;">
                                            توقيع المحكوم (@ViewBag.Data.Name)
                                        </label>
                                        <canvas id="signatureCanvas"
                                                height="150"
                                                width="500"
                                                style="border:2px dashed #81715e; border-radius:8px; cursor:crosshair; background:white; touch-action: none; display:block; margin:10px auto;">
                                        </canvas>
                                    </div>

                                    <div class="mt-3 text-center">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSignature()">
                                            <i class="fas fa-eraser"></i> مسح التوقيع
                                        </button>
                                        <button type="button" class="btn btn-sm" style="background:#81715e; color:white;" onclick="saveAndSubmit()">
                                            <i class="fas fa-save"></i> حفظ التوقيع وإرسال
                                        </button>
                                    </div>

                                    <input type="hidden" name="Signature" id="Signature" />
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-4 right-column">
                <!-- متابعة التقرير -->
                <div class="section-container">
                    <div class="Subtitle">متابعة التقرير</div>
                    <div class="p-2">
                        <!-- تحرير التقرير -->
                        <div class="row">
                            <div class="col-sm-12 p-3 fw-bold" style="background-color:#e9f0f5">
                                <i class="fas fa-file" style="margin-left:5px; color:#5e9cce;"></i>
                                تحرير التقرير
                            </div>
                        </div>
                        <div class="row-detail">
                            <div class="row">
                                <div class="col-sm-5"><label class="control-label">تاريخ الإنشاء</label></div>
                                <div class="col-sm-7"><span class="detail-value">@Html.DisplayFor(m => m.CreatedDate)</span></div>
                            </div>
                        </div>
                        <div class="row-detail">
                            <div class="row">
                                <div class="col-sm-5"><label class="control-label">منشئ التقرير</label></div>
                                <div class="col-sm-7"><span class="detail-value">@Model.CreatedBy</span></div>
                            </div>
                        </div>

                        <!-- تعديل التقرير -->
                        @if (!string.IsNullOrWhiteSpace(Model.EditedBy))
                        {
                            <div class="row">
                                <div class="col-sm-12 p-3 fw-bold" style="background-color:#f9f7e7">
                                    <i class="fas fa-edit" style="margin-left:5px; color:#d4a017;"></i>
                                    تعديل التقرير
                                </div>
                            </div>
                            <div class="row-detail">
                                <div class="row">
                                    <div class="col-sm-5"><label class="control-label">آخر تعديل بواسطة</label></div>
                                    <div class="col-sm-7"><span class="detail-value">@Model.EditedBy</span></div>
                                </div>
                            </div>
                            <div class="row-detail">
                                <div class="row">
                                    <div class="col-sm-5"><label class="control-label">تاريخ التعديل</label></div>
                                    <div class="col-sm-7"><span class="detail-value">@Html.DisplayFor(m => m.EditDate)</span></div>
                                </div>
                            </div>
                            <div class="row-detail">
                                <div class="row">
                                    <div class="col-sm-5"><label class="control-label">ملاحظات التعديل</label></div>
                                    <div class="col-sm-7"><span class="detail-value">@Model.EditNote</span></div>
                                </div>
                            </div>
                        }


                    </div>
                </div>

                <!-- إحصائيات الخدمة -->
                <div class="section-container">
                    <div class="Subtitle">إحصائيات الخدمة</div>
                    <div class="p-2">
                        <div class="row-detail">
                            <div class="row">
                                <div class="col-sm-7"><label class="control-label">حالة الخدمة الحالية</label></div>
                                <div class="col-sm-5">
                                    @{
                                        if (Model.EndDate.HasValue && Model.EndDate.Value < DateTime.Now)
                                        {
                                            <span class="status-badge status-active">انتهاء فترة الخدمة</span>
                                        }
                                        else if (Model.StartDate.HasValue && Model.StartDate.Value <= DateTime.Now)
                                        {
                                            <span class="status-badge status-pending">قيد التنفيذ</span>
                                        }
                                        else
                                        {
                                            <span class="status-badge status-inactive">لم تبدأ بعد</span>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="row-detail">
                            <div class="row">
                                <div class="col-sm-7"><label class="control-label">نسبة الإنجاز</label></div>
                                <div class="col-sm-5">
                                    @{
                                        if (Model.StartDate.HasValue && Model.EndDate.HasValue)
                                        {
                                            var totalDays = (Model.EndDate.Value - Model.StartDate.Value).Days;
                                            var passedDays = (DateTime.Now - Model.StartDate.Value).Days;
                                            var percentage = totalDays > 0 ? Math.Min(100, Math.Max(0, (passedDays * 100) / totalDays)) : 0;
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar" style="width: @percentage%; background-color: #ff9800;"
                                                     aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100">
                                                    @percentage%
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="detail-value">غير متاح</span>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="service-period-box">
                            <div class="row">
                                <div class="col-sm-4 text-center">
                                    <div class="period-label">مدة الخدمة الكلية</div>
                                    <div class="period-value">
                                        @{
                                            if (Model.StartDate.HasValue && Model.EndDate.HasValue)
                                            {
                                                var days = (Model.EndDate.Value - Model.StartDate.Value).Days;
                                                <span>@days يوم</span>
                                            }
                                            else
                                            {
                                                <span>غير محدد</span>
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="col-sm-4 text-center">
                                    <div class="period-label">الأيام المنجزة</div>
                                    <div class="period-value">
                                        @{
                                            if (Model.StartDate.HasValue && DateTime.Now >= Model.StartDate.Value)
                                            {
                                                var completedDays = Math.Min(
                                                    (DateTime.Now - Model.StartDate.Value).Days,
                                                    Model.EndDate.HasValue ? (Model.EndDate.Value - Model.StartDate.Value).Days : 0
                                                );
                                                <span>@completedDays يوم</span>
                                            }
                                            else
                                            {
                                                <span>لم تبدأ</span>
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="col-sm-4 text-center">
                                    <div class="period-label">الأيام المتبقية</div>
                                    <div class="period-value">
                                        @{
                                            if (Model.EndDate.HasValue)
                                            {
                                                var remainingDays = (Model.EndDate.Value - DateTime.Now).Days;
                                                if (remainingDays > 0)
                                                {
                                                    <span>@remainingDays يوم</span>
                                                }
                                                else
                                                {
                                                    <span>انتهت الخدمة</span>
                                                }
                                            }
                                            else
                                            {
                                                <span>غير محدد</span>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Hover effect for sections
            $('.section-container').hover(
                function () { $(this).css('box-shadow', '0 4px 8px rgba(129, 113, 94, 0.1)'); },
                function () { $(this).css('box-shadow', 'none'); }
            );

            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip();

            // Print handlers
            window.addEventListener('beforeprint', function () {
                $('.btn-back, .btn-edit, .header-actions').hide();
            });

            window.addEventListener('afterprint', function () {
                $('.btn-back, .btn-edit, .header-actions').show();
            });
        });
    </script>

        <script>
            // Global signature functions
            function clearSignature() {
                const canvas = document.getElementById('signatureCanvas');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }

            function saveAndSubmit() {
                const canvas = document.getElementById('signatureCanvas');
                if (!canvas) {
                    alert('Canvas not found');
                    return false;
                }

                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const isCanvasBlank = !imageData.data.some(channel => channel !== 0);

                if (isCanvasBlank) {
                    alert('الرجاء التوقيع قبل الحفظ');
                    return false;
                }

                const dataURL = canvas.toDataURL('image/png');
                document.getElementById('Signature').value = dataURL;
                document.getElementById('signForm').submit();
            }

            // Document ready
            $(document).ready(function () {
                // Hover effects
                $('.section-container').hover(
                    function () { $(this).css('box-shadow', '0 4px 8px rgba(129, 113, 94, 0.1)'); },
                    function () { $(this).css('box-shadow', 'none'); }
                );

                $('[data-toggle="tooltip"]').tooltip();

                // Signature Canvas
                const canvas = document.getElementById('signatureCanvas');

                if (canvas) {
                    let drawing = false;
                    let lastX = 0;
                    let lastY = 0;
                    const ctx = canvas.getContext('2d');

                    ctx.lineWidth = 2.2;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.strokeStyle = '#000';

                    function getPos(e) {
                        const rect = canvas.getBoundingClientRect();
                        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                        return {
                            x: clientX - rect.left,
                            y: clientY - rect.top
                        };
                    }

                    canvas.addEventListener('mousedown', (e) => {
                        drawing = true;
                        const pos = getPos(e);
                        lastX = pos.x;
                        lastY = pos.y;
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                    });

                    canvas.addEventListener('mousemove', (e) => {
                        if (!drawing) return;
                        const pos = getPos(e);
                        ctx.lineTo(pos.x, pos.y);
                        ctx.stroke();
                        lastX = pos.x;
                        lastY = pos.y;
                    });

                    canvas.addEventListener('mouseup', () => drawing = false);
                    canvas.addEventListener('mouseout', () => drawing = false);

                    canvas.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        drawing = true;
                        const pos = getPos(e);
                        lastX = pos.x;
                        lastY = pos.y;
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                    }, { passive: false });

                    canvas.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        if (!drawing) return;
                        const pos = getPos(e);
                        ctx.lineTo(pos.x, pos.y);
                        ctx.stroke();
                        lastX = pos.x;
                        lastY = pos.y;
                    }, { passive: false });

                    canvas.addEventListener('touchend', () => drawing = false);
                }

                // Print handlers
                window.addEventListener('beforeprint', () => {
                    $('.btn-back, .btn-edit, .header-actions').hide();
                });

                window.addEventListener('afterprint', () => {
                    $('.btn-back, .btn-edit, .header-actions').show();
                });
            });
        </script>
    
}