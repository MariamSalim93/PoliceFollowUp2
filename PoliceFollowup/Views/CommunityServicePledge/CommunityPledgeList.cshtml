@model IEnumerable<SharedLayer.Models.CommunityServicePledgeDTO>


    @{
        ViewBag.Title = "قائمة تعهدات تنفيذ الخدمة المجتمعية";
    }
    <head>
        <link href="~/Content/CSSFiles/HomeStyle.css" rel="stylesheet" />
        <link href="~/Content/CSSFiles/StatusStyle.css" rel="stylesheet" />
        <style>

            @@media print {
                @@page {
                    size: A3 landscape;
                    font-size: 8px;
                }
            }

            table thead tr {
                border: none;
            }
        </style>

    </head>

    <div class="container-fluid mt-3">
        <div class="p-3 bg-white shadow-sm">
            <div class="d-flex align-items-center" style="gap: 10px;">
                <img src="~/Content/images/student.png" width="34" style="margin-top: -4px;" />
                <h3 class="mb-0" style="color: #7b7268;">قائمة تعهدات تنفيذ الخدمة المجتمعية</h3>
            </div>
            <br />
            <table id="TableId" class="display border-0 nowrap" style="width:100%;font-size:smaller ">
                <thead style="text-align:right;">
                    <tr style="background-color: #e0dad1; color: #221f1c; ">
                        <th> @Html.DisplayNameFor(model => model.ReportID)</th>
                        <th> @Html.DisplayNameFor(model => model.FileNo)</th>
                        <th> @Html.DisplayNameFor(model => model.AccusationType)</th>
                        <th> @Html.DisplayNameFor(model => model.StartDate)</th>
                        <th> @Html.DisplayNameFor(model => model.EndDate)</th>
                        <th> @Html.DisplayNameFor(model => model.CreatedDate)</th>
                        <th> @Html.DisplayNameFor(model => model.CreatedBy)</th>
                        <th>التفاصيل</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    @section scripts {
        <!-- DataTables CSS -->
        <link href="~/Content/DataTables/css/jquery.dataTables.min.css" rel="stylesheet" />
        <link href="~/Content/DataTables/css/responsive.dataTables.min.css" rel="stylesheet" />
        <link href="~/css/font-awesome.min.css" rel="stylesheet" />

        <!-- jQuery -->
        <script src="~/Scripts/jquery-3.4.1.min.js"></script>

        <!-- DataTables JS -->
        <script src="~/Scripts/DataTables/jquery.dataTables.min.js"></script>
        <script src="~/Scripts/DataTables/dataTables.responsive.min.js"></script>

        <!-- Buttons JS for export functionality -->
        <script src="~/Scripts/DataTables/dataTables.buttons.min.js"></script>
        <script src="~/Scripts/DataTables/buttons.flash.min.js"></script>
        <script src="~/Scripts/jszip.min.js"></script>
        <script src="~/Scripts/pdfmake/pdfmake.min.js"></script>
        <script src="~/Scripts/pdfmake/vfs_fonts.js"></script>
        <script src="~/Scripts/DataTables/buttons.html5.min.js"></script>
        <script src="~/Scripts/DataTables/buttons.print.min.js"></script>
        <script src="~/Scripts/mainScripts/InfoSourceDT.js"></script>
        <script type="text/javascript">

$(document).ready(function () {

    // Reusable date formatting function with null handling
    function formatDateColumn(defaultText) {
        return function(data, type, row) {
            if (type === 'display' || type === 'filter') {
                // Check if data is null or undefined
                if (!data || data === null) {
                    return defaultText || "";
                }

                // Try to parse .NET Date format /Date(1234567890)/
                var match = data.match(/\/Date\((\d+)\)\//);
                if (match) {
                    var date = new Date(parseInt(match[1], 10));
                    // Format as dd/MM/yyyy for Arabic context
                    var day = date.getDate();
                    var month = date.getMonth() + 1;
                    var year = date.getFullYear();

                    // Pad with zeros if needed
                    day = day < 10 ? '0' + day : day;
                    month = month < 10 ? '0' + month : month;

                    return day + '/' + month + '/' + year;
                }

                // Try to parse ISO date format as fallback
                try {
                    var date = new Date(data);
                    if (!isNaN(date.getTime())) {
                        var day = date.getDate();
                        var month = date.getMonth() + 1;
                        var year = date.getFullYear();

                        day = day < 10 ? '0' + day : day;
                        month = month < 10 ? '0' + month : month;

                        return day + '/' + month + '/' + year;
                    }
                } catch(e) {
                    // Continue to return invalid date message
                }

                return "تاريخ غير صالح";
            }
            return data;
        };
    }

    var oTable;
    $.ajax({
        url: "@Url.Action("GetListOfCommunityPledgeJson", "CommunityServicePledge")",
        type: "GET",
        dataType: "json",
        success: function(data) {
            oTable = $('#TableId').DataTable({
                data: data,
                responsive: true,
                columns: [
                    { data: "ReportID", width: 70 },
                    { data: "FileNo", width: 200 },
                    { data: "AccusationType", width: 200 },
                    {
                        data: "StartDate",
                        width: 70,
                        render: formatDateColumn("")
                    },
                    {
                        data: "EndDate",
                        width: 70,
                        render: formatDateColumn(" ") // Shows "Ongoing" for null end dates
                    },
                    {
                        data: "CreatedDate",
                        width: 70,
                        render: formatDateColumn("")
                    },
                    { data: "CreatedBy", width: 200 },
                    {
                        data: null,
                        width: 40,
                        orderable: false,
                        render: function (data, type, row) {
                            return '<a href="/CommunityServicePledge/CommunityPledgeDetails/' + row.ReportID +
                                   '" target="_blank" data-toggle="tooltip" data-placement="left" title="التفاصيل" ' +
                                   'style="text-decoration:none"><img src="/Content/images/View.png" width="24" /> </a>';
                        }
                    }
                ],
                order: [[0, 'desc']],
                language: {
                    search: "",
                    searchPlaceholder: " الاستعــلام",
                    sLengthMenu: "_MENU_ ",
                    info: "عرض _START_ إلى _END_ من اجمالي _TOTAL_ ",
                    infoFiltered: "(تصفية _MAX_ من الاجمالي)",
                    infoEmpty: "لا توجد بيانات",
                    zeroRecords: "لم يتم العثور على نتائج",
                    paginate: {
                        next: 'التالي',
                        previous: 'السابق'
                    }
                },
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'copy',
                        text: '<i class="fa fa-copy"></i> نسخ',
                        className: 'btn btn-sm buttons-copy'
                    },
                    {
                        extend: 'excel',
                        text: '<i class="fa fa fa-file-excel-o"></i> اكسل',
                        className: 'btn btn-sm buttons-excel',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6] // Exclude the action column
                        }
                    },
                    {
                        extend: 'print',
                        text: '<i class="fa fa-print"></i> طباعة',
                        className: 'btn btn-sm buttons-print',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6] // Exclude the action column
                        }
                    }
                ],
                initComplete: function () {
                    $('.dataTables_filter input').addClass('form-control');

                    // Initialize tooltips
                    $('[data-toggle="tooltip"]').tooltip();
                }
            });

            // Custom search on header inputs (if you have them)
            $('input', oTable.table().header()).on('keyup', function () {
                var colIdx = $(this).closest('th').index();
                oTable.column(colIdx).search(this.value).draw();
            });
        },
        error: function(xhr, status, error) {
            console.error("An error occurred:", status, error);
            // Show user-friendly error message in Arabic
            alert("حدث خطأ أثناء تحميل البيانات. الرجاء المحاولة مرة أخرى.");
        }
    });
});
        </script>

    }

